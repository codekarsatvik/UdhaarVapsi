<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Debt Collection Voice Agent - Test Interface</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <h1>AI Debt Collection Voice Agent - Test Interface</h1>
        
        <!-- Test Call Form -->
        <div class="test-section">
            <h2>Test Call</h2>
            <div class="form-group">
                <label for="testPhoneNumber">Phone Number</label>
                <input type="tel" id="testPhoneNumber" placeholder="+1234567890" required>
            </div>
            <div class="form-group">
                <label for="testAmount">Amount Due</label>
                <input type="number" id="testAmount" step="0.01" required>
            </div>
            <div class="form-group">
                <label for="testDueDate">Due Date</label>
                <input type="date" id="testDueDate" required>
            </div>
            <div class="form-group">
                <label for="testAccountNumber">Account Number (Optional)</label>
                <input type="text" id="testAccountNumber">
            </div>
            <button onclick="startTestCall()" class="call-button">
                <span class="button-text">Start Test Call</span>
                <div class="loading-spinner"></div>
            </button>
        </div>

        <!-- Voice Recording Test -->
        <div class="test-section">
            <h2>Voice Recording Test</h2>
            <div class="controls">
                <button onclick="startRecording()">Start Recording</button>
                <button onclick="stopRecording()">Stop Recording</button>
                <button onclick="playGreeting()">Play Greeting</button>
            </div>
            <div class="log" id="log"></div>
            <div class="transcript" id="transcript"></div>
        </div>

        <!-- Call Status -->
        <div class="test-section">
            <h2>Call Status</h2>
            <div class="status-card">
                <div class="status-header">
                    <span class="status-label">Status:</span>
                    <span id="callStatus" class="status-value">Not Started</span>
                </div>
                <div class="status-details">
                    <div class="detail-item">
                        <span class="detail-label">Call ID:</span>
                        <span id="callId" class="detail-value">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Duration:</span>
                        <span id="callDuration" class="detail-value">00:00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conversation Log -->
        <div class="test-section">
            <h2>Conversation Log</h2>
            <div id="conversationContainer" class="conversation-container">
                <!-- Messages will be added here dynamically -->
            </div>
        </div>
    </div>

    <script>
        let callStartTime = null;
        let durationInterval = null;
        let mediaRecorder = null;
        let audioChunks = [];

        // Format phone number as user types
        const phoneInput = document.getElementById('testPhoneNumber');
        phoneInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 0) {
                value = '+' + value;
            }
            e.target.value = value;
        });

        async function startTestCall() {
            try {
                const formData = {
                    phone_number: document.getElementById('testPhoneNumber').value,
                    amount: parseFloat(document.getElementById('testAmount').value),
                    due_date: document.getElementById('testDueDate').value,
                    account_number: document.getElementById('testAccountNumber').value || null
                };

                // Update UI
                document.getElementById('callStatus').textContent = 'Initiating call...';
                document.getElementById('callStatus').style.color = 'var(--warning-color)';

                const response = await fetch('/api/call', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Failed to initiate call');
                }

                const data = await response.json();
                
                // Update UI with call information
                document.getElementById('callId').textContent = data.call_id;
                document.getElementById('callStatus').textContent = 'Call in progress';
                document.getElementById('callStatus').style.color = 'var(--success-color)';
                
                // Start duration timer
                startCallTimer();
                
                // Add system message
                addMessage('Call initiated successfully', 'system');
                
                // Start WebSocket connection for real-time updates
                connectWebSocket(data.call_id);
                
            } catch (error) {
                console.error('Error:', error);
                addMessage(`Failed to initiate call: ${error.message}`, 'system');
                document.getElementById('callStatus').textContent = 'Call failed';
                document.getElementById('callStatus').style.color = 'var(--error-color)';
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const formData = new FormData();
                    formData.append('audio', audioBlob);

                    try {
                        logMessage('Sending audio for processing...');
                        const response = await fetch('/webhook/twilio', {
                            method: 'POST',
                            body: formData
                        });

                        if (!response.ok) {
                            throw new Error('Failed to process audio');
                        }

                        const result = await response.json();
                        logMessage('Audio processed successfully', 'success');
                    } catch (error) {
                        logMessage(`Error: ${error.message}`, 'error');
                    }
                };

                mediaRecorder.start();
                logMessage('Recording started...', 'success');
            } catch (error) {
                logMessage(`Error: ${error.message}`, 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                logMessage('Recording stopped...', 'success');
            }
        }

        async function playGreeting() {
            try {
                logMessage('Playing greeting...');
                const response = await fetch('/audio_files/greeting.mp3');
                
                if (!response.ok) {
                    throw new Error('Failed to fetch greeting audio');
                }

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                await audio.play();
                logMessage('Playing greeting...', 'success');
            } catch (error) {
                logMessage(`Error: ${error.message}`, 'error');
            }
        }

        function startCallTimer() {
            callStartTime = Date.now();
            durationInterval = setInterval(updateDuration, 1000);
        }

        function updateDuration() {
            const duration = Math.floor((Date.now() - callStartTime) / 1000);
            const minutes = Math.floor(duration / 60).toString().padStart(2, '0');
            const seconds = (duration % 60).toString().padStart(2, '0');
            document.getElementById('callDuration').textContent = `${minutes}:${seconds}`;
        }

        function addMessage(text, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = text;
            document.getElementById('conversationContainer').appendChild(messageDiv);
            messageDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function logMessage(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            document.getElementById('log').appendChild(entry);
            document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
        }

        function connectWebSocket(callId) {
            const ws = new WebSocket(`ws://${window.location.host}/ws/call/${callId}`);

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                switch (data.type) {
                    case 'transcript':
                        addMessage(data.text, data.speaker === 'agent' ? 'agent' : 'customer');
                        break;
                        
                    case 'call_ended':
                        clearInterval(durationInterval);
                        document.getElementById('callStatus').textContent = 'Call ended';
                        document.getElementById('callStatus').style.color = 'var(--text-secondary)';
                        addMessage('Call ended', 'system');
                        ws.close();
                        break;
                        
                    case 'error':
                        addMessage(`Error: ${data.message}`, 'system');
                        break;
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                addMessage('Connection error occurred', 'system');
            };

            ws.onclose = () => {
                console.log('WebSocket connection closed');
            };
        }
    </script>
</body>
</html> 